# MultiZlogin

Há»‡ thá»‘ng quáº£n lÃ½ Ä‘a tÃ i khoáº£n Zalo, há»— trá»£ Ä‘Äƒng nháº­p vÃ  quáº£n lÃ½ nhiá»u tÃ i khoáº£n Zalo cÃ¹ng lÃºc, tÃ­ch há»£p proxy vÃ  webhook vá»›i tÃ­nh nÄƒng auto-reconnection vÃ  persistent storage.

## TÃ­nh nÄƒng

- âœ… ÄÄƒng nháº­p nhiá»u tÃ i khoáº£n Zalo thÃ´ng qua mÃ£ QR
- âœ… Há»— trá»£ Ä‘Äƒng nháº­p qua proxy vá»›i load balancing
- âœ… Quáº£n lÃ½ danh sÃ¡ch proxy tá»± Ä‘á»™ng
- âœ… Cáº¥u hÃ¬nh webhook riÃªng cho tá»«ng loáº¡i sá»± kiá»‡n
- âœ… GiÃ¡m sÃ¡t tráº¡ng thÃ¡i káº¿t ná»‘i cá»§a cÃ¡c tÃ i khoáº£n
- âœ… **Auto-reconnection** khi máº¥t káº¿t ná»‘i
- âœ… **Health check mechanism** Ä‘á»ƒ phÃ¡t hiá»‡n connection issues
- âœ… **Persistent storage** vá»›i Docker volumes (khÃ´ng máº¥t data khi restart)
- âœ… API RESTful Ä‘á»ƒ tÃ­ch há»£p vá»›i cÃ¡c há»‡ thá»‘ng khÃ¡c
- âœ… Nháº­n tin nháº¯n vÃ  sá»± kiá»‡n tá»« Zalo thÃ´ng qua webhook real-time

## Cáº£i tiáº¿n má»›i (v2.0)

### ğŸ”„ Auto-Reconnection
- Tá»± Ä‘á»™ng phÃ¡t hiá»‡n vÃ  reconnect khi connection bá»‹ Ä‘Ã³ng
- Exponential backoff Ä‘á»ƒ trÃ¡nh spam reconnect
- Retry logic thÃ´ng minh vá»›i cooldown period
- **Race condition protection** vá»›i relogin lock mechanism

### ğŸ¥ Health Check
- Kiá»ƒm tra connection health má»—i 2 phÃºt
- Docker health check endpoint: `/health`
- Tá»± Ä‘á»™ng trigger reconnection khi phÃ¡t hiá»‡n váº¥n Ä‘á»
- Script monitoring: `./scripts/health-check.sh`

### ğŸ’¾ Docker Volumes
- LÆ°u trá»¯ cookies vÃ  session persistent
- Giá»¯ láº¡i cáº¥u hÃ¬nh proxy
- KhÃ´ng máº¥t data khi restart/rebuild container

### ğŸ›¡ï¸ Production-Ready Stability
- **KhÃ´ng cÃ³ memory leaks** - Proper cleanup cho timers, event listeners, temp files
- **Error handling Ä‘áº§y Ä‘á»§** - Táº¥t cáº£ promises vÃ  async operations Ä‘Æ°á»£c handle
- **Resource management** - WebSocket connections vÃ  file operations Ä‘Æ°á»£c cleanup Ä‘Ãºng cÃ¡ch
- **CÃ³ thá»ƒ cháº¡y á»•n Ä‘á»‹nh vÃ´ thá»i háº¡n** - ÄÃ£ fix 9 váº¥n Ä‘á» nghiÃªm trá»ng

ğŸ“– **Chi tiáº¿t:** Xem [SYSTEM_CHECK_REPORT.md](SYSTEM_CHECK_REPORT.md) Ä‘á»ƒ biáº¿t táº¥t cáº£ cÃ¡c váº¥n Ä‘á» Ä‘Ã£ Ä‘Æ°á»£c sá»­a.

## CÃ i Ä‘áº·t

### YÃªu cáº§u há»‡ thá»‘ng

- Node.js v16 trá»Ÿ lÃªn
- Docker & Docker Compose (khuyáº¿n nghá»‹)
- npm hoáº·c yarn

### CÃ¡c bÆ°á»›c cÃ i Ä‘áº·t

1. Clone repository:
   ```bash
   git clone https://github.com/yourusername/multizlogin.git
   cd multizlogin
   ```

2. Táº¡o file `.env` tá»« file máº«u:
   ```bash
   cp .env.example .env
   ```

3. Cáº¥u hÃ¬nh cÃ¡c biáº¿n mÃ´i trÆ°á»ng trong file `.env`:
   ```env
   PORT=3000
   SESSION_SECRET=your_secret_key_change_this
   MESSAGE_WEBHOOK_URL=https://your-n8n.com/webhook/message
   GROUP_EVENT_WEBHOOK_URL=https://your-n8n.com/webhook/group-events
   REACTION_WEBHOOK_URL=https://your-n8n.com/webhook/reactions
   WEBHOOK_LOGIN_SUCCESS=https://your-n8n.com/webhook/login-success
   ```

4. Khá»Ÿi Ä‘á»™ng vá»›i Docker (Khuyáº¿n nghá»‹):
   ```bash
   docker-compose up -d
   ```
   
   Hoáº·c cháº¡y trá»±c tiáº¿p vá»›i Node.js:
   ```bash
   npm install
   npm start
   ```

5. Kiá»ƒm tra health status:
   ```bash
   curl http://localhost:3000/health
   ```

## Docker Volumes vÃ  Persistent Storage

Há»‡ thá»‘ng sá»­ dá»¥ng Docker volumes Ä‘á»ƒ lÆ°u trá»¯ data persistent:

```yaml
volumes:
  - ./data:/app/data              # Cookies vÃ  proxies
```

### Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u trá»¯:
- **Cookies**: `./data/cookies/cred_<ownId>.json` - Session cookies cho auto-login
- **User Accounts & API Keys**: `./data/cookies/users.json` - ThÃ´ng tin Ä‘Äƒng nháº­p vÃ  API keys
- **Proxies**: `./data/proxies.json` - Danh sÃ¡ch proxy vÃ  usage tracking
- **Webhook URLs**: Cáº¥u hÃ¬nh qua environment variables trong `.env`

### âš ï¸ QUAN TRá»ŒNG: Deploy trÃªn Dokploy/Cloud

Khi deploy trÃªn cÃ¡c platform nhÆ° Dokploy, Heroku, Railway, v.v., **Báº®T BUá»˜C pháº£i cáº¥u hÃ¬nh volumes** Ä‘á»ƒ trÃ¡nh máº¥t dá»¯ liá»‡u khi redeploy.

**Váº¥n Ä‘á»:** Má»—i láº§n redeploy, container má»›i Ä‘Æ°á»£c táº¡o vÃ  data trong container cÅ© bá»‹ máº¥t.

**Giáº£i phÃ¡p:** 

1. **Quick Setup:**
   ```bash
   ./scripts/dokploy-setup.sh
   ```

2. **Sá»­ dá»¥ng file cáº¥u hÃ¬nh cho Dokploy:**
   - File: [dokploy-compose.yaml](dokploy-compose.yaml)
   - Sá»­ dá»¥ng **named volumes** thay vÃ¬ bind mounts
   - Táº¡o volume `multizlogin-data` mount vÃ o `/app/data`

ğŸ“– **Chi tiáº¿t:** Xem [DOKPLOY_DEPLOY_GUIDE.md](DOKPLOY_DEPLOY_GUIDE.md) Ä‘á»ƒ biáº¿t hÆ°á»›ng dáº«n Ä‘áº§y Ä‘á»§.

### Reset container an toÃ n (giá»¯ data):
```bash
docker-compose restart              # Restart nhanh
# hoáº·c
docker-compose down && docker-compose up -d  # Restart Ä‘áº§y Ä‘á»§
```

3. Khá»Ÿi Ä‘á»™ng vá»›i Docker:
   ```
   docker-compose up -d
   ```

4. Cáº­p nháº­t vÃ  triá»ƒn khai image má»›i:
   ```
   ./scripts/update-zalo-server.sh
   ```

### Xuáº¥t báº£n Docker Image

Náº¿u báº¡n muá»‘n build vÃ  xuáº¥t báº£n Docker image cá»§a riÃªng mÃ¬nh:

1. TrÆ°á»›c khi build, lÃ m sáº¡ch thÃ´ng tin nháº¡y cáº£m:
   ```
   ./scripts/clean-for-publish.sh
   ```
   Script nÃ y sáº½ táº¡o báº£n sao lÆ°u thÃ´ng tin nháº¡y cáº£m vÃ  lÃ m sáº¡ch dá»± Ã¡n Ä‘á»ƒ xuáº¥t báº£n an toÃ n.

2. Build vÃ  xuáº¥t báº£n image:
   ```
   docker-compose -f docker-compose.new.yaml build
   docker tag multizlogin_zalo-server:latest yourusername/zalo-server:latest
   docker push yourusername/zalo-server:latest
   ```

3. Sau khi xuáº¥t báº£n xong, khÃ´i phá»¥c láº¡i thÃ´ng tin nháº¡y cáº£m:
   ```
   ./scripts/restore-after-publish.sh
   ```

> **LÆ°u Ã½**: Scripts má»›i Ä‘Ã£ Ä‘Æ°á»£c di chuyá»ƒn vÃ o thÆ° má»¥c `scripts/`. Náº¿u báº¡n sá»­ dá»¥ng cÃ¡c script tá»« thÆ° má»¥c gá»‘c, hÃ£y cáº­p nháº­t Ä‘á»ƒ sá»­ dá»¥ng phiÃªn báº£n má»›i tá»« thÆ° má»¥c `scripts/`.

### Xá»­ lÃ½ lá»—i Docker Build

Náº¿u báº¡n gáº·p lá»—i liÃªn quan Ä‘áº¿n thiáº¿u module nhÆ° "Cannot find module 'ejs'" khi cháº¡y Docker, hÃ£y sá»­ dá»¥ng script sau Ä‘á»ƒ sá»­a:

```bash
./scripts/fix-docker-build.sh
```

Script nÃ y sáº½:
- Cáº­p nháº­t Dockerfile Ä‘á»ƒ cÃ i Ä‘áº·t Ä‘Ãºng cÃ¡c dependencies
- Cáº­p nháº­t .dockerignore Ä‘á»ƒ loáº¡i trá»« cÃ¡c file khÃ´ng cáº§n thiáº¿t
- Cung cáº¥p tÃ¹y chá»n Ä‘á»ƒ build láº¡i Docker image ngay láº­p tá»©c

Sau khi cháº¡y script nÃ y, báº¡n cÃ³ thá»ƒ khá»Ÿi Ä‘á»™ng láº¡i container:

```bash
docker-compose -f docker-compose.new.yaml up -d
```

## Sá»­ dá»¥ng

1. Má»Ÿ trÃ¬nh duyá»‡t vÃ  truy cáº­p: `http://localhost:3000`
2. ÄÄƒng nháº­p tÃ i khoáº£n Zalo thÃ´ng qua nÃºt "ÄÄƒng nháº­p Zalo"
3. Quáº£n lÃ½ tÃ i khoáº£n vÃ  thiáº¿t láº­p webhook trong trang "Quáº£n lÃ½ tÃ i khoáº£n"
4. Quáº£n lÃ½ proxy trong trang "Quáº£n lÃ½ Proxy"

## API

### XÃ¡c thá»±c API

Táº¥t cáº£ cÃ¡c API Ä‘á»u yÃªu cáº§u API key Ä‘á»ƒ xÃ¡c thá»±c. API key Ä‘Æ°á»£c cáº¥u hÃ¬nh trong file `.env`.

```
X-API-Key: your_api_key
```

### CÃ¡c API chÃ­nh

- `GET /api/accounts`: Láº¥y danh sÃ¡ch tÃ i khoáº£n
- `GET /api/webhook-configs`: Láº¥y táº¥t cáº£ cáº¥u hÃ¬nh webhook
- `GET /api/webhook-config/:ownId`: Láº¥y cáº¥u hÃ¬nh webhook cho má»™t tÃ i khoáº£n
- `POST /api/webhook-config/:ownId`: Cáº­p nháº­t cáº¥u hÃ¬nh webhook cho má»™t tÃ i khoáº£n
- `DELETE /api/webhook-config/:ownId`: XÃ³a cáº¥u hÃ¬nh webhook cho má»™t tÃ i khoáº£n
- `GET /api/status`: Kiá»ƒm tra tráº¡ng thÃ¡i káº¿t ná»‘i cá»§a há»‡ thá»‘ng

## TÃ­ch há»£p vá»›i n8n

MultiZlogin Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ tÃ­ch há»£p dá»… dÃ ng vá»›i n8n Ä‘á»ƒ tá»± Ä‘á»™ng hÃ³a quy trÃ¬nh lÃ m viá»‡c.

1. Táº¡o Webhook Node trong n8n
2. Cáº¥u hÃ¬nh webhook URL trong MultiZlogin Ä‘á»ƒ trá» Ä‘áº¿n URL cá»§a Webhook Node
3. CÃ¡c sá»± kiá»‡n tá»« Zalo sáº½ Ä‘Æ°á»£c gá»­i Ä‘áº¿n n8n Ä‘á»ƒ xá»­ lÃ½

## ÄÃ³ng gÃ³p

Má»i Ä‘Ã³ng gÃ³p Ä‘á»u Ä‘Æ°á»£c hoan nghÃªnh! Vui lÃ²ng má»Ÿ issue hoáº·c pull request Ä‘á»ƒ cáº£i thiá»‡n dá»± Ã¡n.

## Giáº¥y phÃ©p

[MIT](LICENSE)

## TuyÃªn bá»‘ trÃ¡ch nhiá»‡m

Dá»± Ã¡n nÃ y Ä‘Æ°á»£c phÃ¡t triá»ƒn vá»›i má»¥c Ä‘Ã­ch nghiÃªn cá»©u vÃ  há»c táº­p. NgÆ°á»i dÃ¹ng chá»‹u hoÃ n toÃ n trÃ¡ch nhiá»‡m khi sá»­ dá»¥ng dá»± Ã¡n nÃ y pháº£i tuÃ¢n thá»§ cÃ¡c Ä‘iá»u khoáº£n dá»‹ch vá»¥ cá»§a Zalo vÃ  cÃ¡c quy Ä‘á»‹nh phÃ¡p luáº­t hiá»‡n hÃ nh. ChÃºng tÃ´i khÃ´ng chá»‹u trÃ¡ch nhiá»‡m cho báº¥t ká»³ hÃ nh vi vi pháº¡m nÃ o.

## Lá»i cáº£m Æ¡n

ChÃ¢n thÃ nh cáº£m Æ¡n Ä‘á»™i ngÅ© ZCA Ä‘Ã£ phÃ¡t triá»ƒn thÆ° viá»‡n zca-js, giÃºp chÃºng tÃ´i cÃ³ thá»ƒ xÃ¢y dá»±ng dá»± Ã¡n nÃ y.